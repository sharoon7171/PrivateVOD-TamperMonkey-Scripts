name: Auto Update Scripts

on:
  push:
    branches: [ main ]
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-scripts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm install -g @octokit/rest
        npm install -g semver
        
    - name: Check for script updates
      run: |
        echo "üîç Checking for script updates..."
        
        # Get latest commit info
        COMMIT_MSG=$(git log -1 --pretty=%B)
        COMMIT_HASH=$(git log -1 --pretty=%H)
        
        echo "üìù Latest commit: $COMMIT_MSG"
        echo "üîó Commit hash: $COMMIT_HASH"
        
        # Check if any .user.js files were modified
        if git diff --name-only HEAD~1 HEAD | grep -q "\.user\.js$"; then
          echo "‚úÖ Script files were updated"
          
          # Create release notes
          echo "## üöÄ Script Updates" > release_notes.md
          echo "" >> release_notes.md
          echo "### Changes in this update:" >> release_notes.md
          echo "- $COMMIT_MSG" >> release_notes.md
          echo "" >> release_notes.md
          echo "### Modified Scripts:" >> release_notes.md
          git diff --name-only HEAD~1 HEAD | grep "\.user\.js$" | while read file; do
            echo "- $file" >> release_notes.md
          done
          
          # Create GitHub release
          gh release create "v$(date +%Y.%m.%d)" \
            --title "Script Updates - $(date +%Y-%m-%d)" \
            --notes-file release_notes.md \
            --latest
            
          echo "üéâ Release created successfully"
        else
          echo "‚ÑπÔ∏è No script files were modified"
        fi
        
    - name: Notify on success
      if: success()
      run: |
        echo "‚úÖ Auto-update workflow completed successfully"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Auto-update workflow failed"
